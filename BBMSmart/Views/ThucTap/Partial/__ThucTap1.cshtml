@using System.Data
@using ProductAllTool.Models.ManageSales;
@{
    var lsthd = (List<objCombox>)Session["listhanhdongdc"];
    var listLoaidc = (List<objCombox>)Session["listLoaidc"];
}
<link href="~/Resource/Content/css/thickbox.css" rel="stylesheet" />
<script src="~/Resource/Scripts/thickbox.js"></script>
<table id="tbl_Item" class="table table-bordered" style="width:99.9%">
    <thead>
        @{
            if (Model != null)
            {
                var dt = Model as DataTable;
                if (dt.Rows.Count > 0)
                {
                    <tr style="background: #ffffff; border-bottom: 1px solid #ddd !important; border-top: 1px solid #fff; border-left: 1px solid #fff; border-right: 1px solid #fff !important;">
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;">@dt.Rows[0]["sumSlTon"]</td>
                        <td class="text-right" style="border: none !important;">@dt.Rows[0]["sumSLD30"]</td>
                        @*<td class="text-right" style="border: none !important;">@dt.Rows[0]["sumDTD30"]</td>
                        <td class="text-right" style="border: none !important;">@dt.Rows[0]["sumGPD30"]</td>*@
                        <td class="text-right" style="border: none !important;"><span id="sumSLDat">@dt.Rows[0]["sumSLDat"]</span></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                        <td class="text-right" style="border: none !important;"></td>
                    </tr>
                }
            }
        }
        <tr>
            <th class="text-left" style="vertical-align: top">
                Nguồn
            </th>
            <th class="text-left" style="vertical-align: top">
                Function
            </th>
            <th class="text-left" style="vertical-align: top">
                CH TSF
            </th>
            <th class="text-left" style="vertical-align: top">
                Miền
            </th>
            <th class="text-left" style="vertical-align: top">
                Tỉnh
            </th>
            <th class="text-left" style="vertical-align: top">
                Mã CH
            </th>
            <th class="text-left" style="vertical-align: top">
                Tên CH
            </th>
            <th class="text-left" style="vertical-align: top">
                Mã <br />hàng
            </th>
            <th class="text-left" style="vertical-align: top">
                Tên hàng
            </th>
            <th class="text-left" style="vertical-align: top">
                PS ERP
            </th>
            <th class="text-left" style="vertical-align: top">
                DS ERP
            </th>
            <th class="text-left" style="vertical-align: top">
                Min PSF
            </th>
            <th class="text-left" style="vertical-align: top">
                SL tồn
            </th>
            <th class="text-left" style="vertical-align: top">
                SL bán D30
            </th>
            <th class="text-left" style="vertical-align: top">
                SL Đặt
            </th>
            <th class="text-left" style="vertical-align: top">
                PS mới<br />
                <input id="psmoiall" type="text" class="form-control" style="width:40px" onchange="js_psmoiall()" />
            </th>
            <th class="text-left" style="vertical-align: top;">
                Từ ngày<br />
                <input type="date" class="form-control" id="fromall" onchange="fromall()" />
            </th>
            <th class="text-left" style="vertical-align: top">
                Đến ngày<br />
                <input type="date" class="form-control" id="toall" onchange="toall()" />
            </th>
            <th class="text-left" style="vertical-align: top">
                <input type="checkbox" id="checkall" onchange="checkall()" />
            </th>
        </tr>
    </thead>
    <tbody>

        @{
            if (Model != null)
            {
                var dt = Model as DataTable;
                if (dt.Rows.Count > 0)
                {
                    var i = 0;
                    foreach (DataRow item in dt.Rows)
                    {
        <tr>
            <td class="text-left" style="width:65px; max-width: 65px;  overflow: hidden;white-space: nowrap">
                @item["NguonNhap"]
            </td>
            <td class="text-left" style="width: 100px; max-width: 100px;  overflow: hidden;white-space: nowrap">
                @item["Function"]
            </td>
            <td class="text-right" style="width: 40px;">
                <span id="tsf_@i">@item["TSF"]</span>
            </td>
            <td class="text-left" style="width: 40px; max-width: 40px;  overflow: hidden;white-space: nowrap">
                @item["Mien"]
            </td>
            <td class="text-left" style="width: 40px;">
                @item["MaTinhCode"]
            </td>
            <td class="text-left" style="width: 40px;">
                <span id="mch_@i">@item["MaCH"]</span>
            </td>
            <td class="text-left" style="max-width: 150px;  overflow: hidden;white-space: nowrap">
                @item["TenCH"]
            </td>
            <td class="text-left" style="width: 40px;">
                <span id="mh_@i">@item["MaHang"]</span>
            </td>
            <td class="text-left" style="  overflow: hidden;white-space: nowrap">
                @item["TenHang"]
            </td>
            <td class="text-right" style="width: 50px;">
                <span id="ps_@i">@item["PS_ERP"]</span>
</td>
            <td class="text-right" style="width: 50px;">
                <span id="ds_@i" style="color:@item["colorDS"]">@item["DailySalesErp"]</span>
            </td>
            <td class="text-right"  style="width: 50px;">
                <span id="min_@i">@item["MinPSFunction"]</span>
</td>
            <td class="text-right"  style="width: 50px;">
                <span id="slt_@i">@item["SlTon"]</span>
</td>
            <td class="text-right"  style="width: 50px;">
                <span id="slb_@i">@item["SLD30"]</span>
</td>
            @*<td class="text-right">
            @item["DTD30"]
        </td>
        <td class="text-right">
            @item["GPD30"]
        </td>*@
            <td class="text-right"  style="width: 50px;">
                <span id="sld_@i" name="soluongdat">@item["SLDat"]</span>
               
            </td>
            <td class="text-left"  style="width: 50px;">
                <input id="psmoi_@i" name="psmoi" type="text" class="form-control" value="@item["PSMoi"]" style="width:40px" onchange="js_cal('@i')" />
            </td>
            <td class="text-left"  style="width: 110px;">
                <input id="from_@i" name="from" type="date" class="form-control" value="@item["Fromdate"]" onchange="fnSaveBak('@i')"/>
            </td>
            <td class="text-left" style="width: 110px;">
                <input id="to_@i" name="to" type="date" class="form-control" value="@item["Todate"]" onchange="fnSaveBak('@i')" />
            </td>
            <td class="text-left">
                <input id="_@i" name="check" type="checkbox" onchange="fnSaveBak('@i')" />
                <span id="dsmoi_@i" style="display:none">@item["DailySalesErpBQ"]</span>
                <span id="frlt_@i" style="display:none">@item["FRLT"]</span>
                <span id="hdd_@i" style="display:none">@item["HangDiDuong"]</span>
            </td>


        </tr>
                        i++;
                    }
                }
            }
        }
    </tbody>
    <tfoot>
    </tfoot>
</table>
<script>

    function js_psmoiall() {
       
        var cboxes = document.getElementsByName('psmoi');
        var psmoiall = $('#psmoiall').val();
        for (var i = 0; i < cboxes.length; i++) {
            $('#' + cboxes[i].id).val(psmoiall).trigger('change');
        }
        
    }

    function fromall() {
        var cboxes = document.getElementsByName('from');
        var fromall = $('#fromall').val();
        for (var i = 0; i < cboxes.length; i++) {
            $('#' + cboxes[i].id).val(fromall).trigger('change');
        }
    }

    function toall() {
        var cboxes = document.getElementsByName('to');
        var toall = $('#toall').val();
        for (var i = 0; i < cboxes.length; i++) {
            $('#' + cboxes[i].id).val(toall).trigger('change');
        }
    }

    function checkall() {
        var cboxes = document.getElementsByName('check');
        var ischeck = $('#checkall').is(":checked");
        for (var i = 0; i < cboxes.length; i++) {
            cboxes[i].checked = ischeck;
            $('#' + cboxes[i].id).trigger('change');
        }
    }

    function js_cal(id) {
        try {
            var ps = parseInt($('#ps_' + id).html().replaceAll(',', ''));
            var psmoi = parseInt($('#psmoi_' + id).val().replaceAll(',', ''));
            var ds = parseFloat($('#ds_' + id).html().replaceAll(',', ''));
            var dsmoi = parseFloat($('#dsmoi_' + id).html().replaceAll(',', ''));
            var hdd = parseFloat($('#hdd_' + id).html().replaceAll(',', ''));
            var slt = parseFloat($('#slt_' + id).html().replaceAll(',', ''));
            var frlt = parseFloat($('#frlt_' + id).html().replaceAll(',', ''));
            if (psmoi >= 0) {
                $('#psmoi_' + id).val(currencyFormat(psmoi));
                if (ps > 0) $('#sld_' + id).html(currencyFormat(psmoi + ds * frlt - slt - hdd));
                else $('#sld_' + id).html(currencyFormat(psmoi + dsmoi * frlt - slt - hdd));
                recalsld();
            } else {
                $('#psmoi_' + id).val('0');
                psmoi = 0;
                if (ps > 0) $('#sld_' + id).html(currencyFormat(psmoi + ds * frlt - slt - hdd));
                else $('#sld_' + id).html(currencyFormat(psmoi + dsmoi * frlt - slt - hdd));
                recalsld();
            }
            fnSaveBak(id);
        } catch (error) { }
    }

    function recalsld() {
        var cboxes = document.getElementsByName('soluongdat');
        var sumsld = 0;
        for (var i = 0; i < cboxes.length; i++) {
            var sld = parseFloat($('#' + cboxes[i].id).html().replaceAll(',', ''));
            if (!isNaN(sld)) sumsld += sld;
        }
        $('#sumSLDat').html(currencyFormat(sumsld));
    }

    function fnSaveBak(strID) {
        
        var ar = {};
        ar.mahang = $('#mh_' + strID).html();
        ar.mach = $('#mch_' + strID).html();
        ar.psmoi = $('#psmoi_' + strID).val().replaceAll(',', '');
        ar.dsmoi = $('#dsmoi_' + strID).html().replaceAll(',', '');
        ar.sldat = $('#sld_' + strID).html().replaceAll(',', '');
        ar.fromdate = $('#from_' + strID).val();
        ar.todate = $('#to_' + strID).val();
        ar.fstatus = $('#_' + strID).is(":checked") ? '1' : '0';

        $.ajax({
            type: "POST",
            url: "/Po2/aron_edit",
            data: JSON.stringify(ar),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (rt) {
                if (rt.code == 0) {

                } else {

                }
            }
        });
    }
</script>


